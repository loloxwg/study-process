# 10.4

## GMP模型

G

M

P

- [ ] 先全局队列，后偷
- [ ] 

## GC

- [ ] 标记清除法

  - [ ] stw

- [ ] 三色标记法

  - [ ] 黑，白，灰
  - [ ] 需要stw

- [ ] 强三色不变式

  - [ ] 黑——>灰

- [ ] 弱三色不变式

  - [ ] 灰——>白

- [ ] 插入写屏障 （满足强

  - [ ] 栈上不能搞 需要STW扫一遍栈

- [ ] 删除写屏障 （满足弱

  - [ ] 回收精度低，下一轮回收

  插入写屏障和删除写屏障的短板：

  - 插入写屏障：结束时需要STW来重新扫描栈，标记栈上引用的白色对象的存活；
  - 删除写屏障：回收精度低，GC开始时STW扫描堆栈来记录初始快照，这个过程会保护开始时刻的所有存活对象。

  #### (1) 混合写屏障规则

  `具体操作`:

  1、GC开始将栈上的对象全部扫描并标记为黑色(之后不再进行第二次重复扫描，无需STW)，

  2、GC期间，任何在栈上创建的新对象，均为黑色。

  3、被删除的对象标记为灰色。

  4、被添加的对象标记为灰色。

  `满足`: 变形的**弱三色不变式**.

#### 总结

 以上便是Golang的GC全部的标记-清除逻辑及场景演示全过程。

GoV1.3- 普通标记清除法，整体过程需要启动STW，效率极低。

GoV1.5- 三色标记法， 堆空间启动写屏障，栈空间不启动，全部扫描之后，需要重新扫描一次栈(需要STW)，效率普通

GoV1.8-三色标记法，混合写屏障机制， 栈空间不启动，堆空间启动。整个过程几乎不需要STW，效率较高。

